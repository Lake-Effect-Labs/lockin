<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock-In Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            margin-bottom: 30px;
            font-size: 32px;
        }
        
        .config {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #2a2a2a;
        }
        
        .config h2 {
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .config input {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .config button {
            padding: 10px 20px;
            background: #6366f1;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        
        .config button:hover {
            background: #4f46e5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a2a;
        }
        
        .stat-label {
            font-size: 14px;
            color: #888;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #6366f1;
        }
        
        .stat-change {
            font-size: 12px;
            color: #10b981;
            margin-top: 5px;
        }
        
        .section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2a2a2a;
        }
        
        .section h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2a2a2a;
        }
        
        th {
            color: #888;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        td {
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .error {
            background: #7f1d1d;
            border: 1px solid #991b1b;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”¥ Lock-In Analytics Dashboard</h1>
        
        <div class="config">
            <h2>Supabase Configuration</h2>
            <input type="text" id="supabaseUrl" placeholder="Supabase URL (https://xxx.supabase.co)">
            <input type="text" id="supabaseKey" placeholder="Supabase Anon Key">
            <button onclick="connect()">Connect & Load Data</button>
        </div>
        
        <div id="error" style="display: none;" class="error"></div>
        <div id="loading" class="loading" style="display: none;">Loading analytics...</div>
        
        <div id="dashboard" style="display: none;">
            <!-- Overview Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="totalUsers">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Leagues</div>
                    <div class="stat-value" id="totalLeagues">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Leagues</div>
                    <div class="stat-value" id="activeLeagues">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Matchups</div>
                    <div class="stat-value" id="totalMatchups">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Leagues Created (7d)</div>
                    <div class="stat-value" id="leaguesCreated7d">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">New Users (7d)</div>
                    <div class="stat-value" id="newUsers7d">-</div>
                </div>
            </div>
            
            <!-- Recent Leagues -->
            <div class="section">
                <h2>Recent Leagues</h2>
                <table id="recentLeagues">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Created</th>
                            <th>Players</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- League Size Distribution -->
            <div class="section">
                <h2>League Size Distribution</h2>
                <table id="leagueSizes">
                    <thead>
                        <tr>
                            <th>Size</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- User Activity -->
            <div class="section">
                <h2>User Activity (Last 7 Days)</h2>
                <table id="userActivity">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>New Users</th>
                            <th>Leagues Created</th>
                            <th>Leagues Joined</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let supabase = null;
        
        // Load saved config
        const savedUrl = localStorage.getItem('supabaseUrl');
        const savedKey = localStorage.getItem('supabaseKey');
        if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
        if (savedKey) document.getElementById('supabaseKey').value = savedKey;
        
        function connect() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                showError('Please enter both Supabase URL and Key');
                return;
            }
            
            // Save config
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            
            // Initialize Supabase
            supabase = window.supabase.createClient(url, key);
            
            loadAnalytics();
        }
        
        async function loadAnalytics() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            
            try {
                // Load all data
                const [users, leagues, matchups, members] = await Promise.all([
                    supabase.from('users').select('id, created_at'),
                    supabase.from('leagues').select('*'),
                    supabase.from('matchups').select('id'),
                    supabase.from('league_members').select('league_id, user_id, joined_at')
                ]);
                
                if (users.error) throw users.error;
                if (leagues.error) throw leagues.error;
                if (matchups.error) throw matchups.error;
                if (members.error) throw members.error;
                
                const usersData = users.data || [];
                const leaguesData = leagues.data || [];
                const matchupsData = matchups.data || [];
                const membersData = members.data || [];
                
                // Calculate stats
                const now = new Date();
                const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                const totalUsers = usersData.length;
                const totalLeagues = leaguesData.length;
                const activeLeagues = leaguesData.filter(l => l.is_active).length;
                const totalMatchups = matchupsData.length;
                
                const leaguesCreated7d = leaguesData.filter(l => 
                    new Date(l.created_at) >= sevenDaysAgo
                ).length;
                
                const newUsers7d = usersData.filter(u => 
                    new Date(u.created_at) >= sevenDaysAgo
                ).length;
                
                // Update stats
                document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();
                document.getElementById('totalLeagues').textContent = totalLeagues.toLocaleString();
                document.getElementById('activeLeagues').textContent = activeLeagues.toLocaleString();
                document.getElementById('totalMatchups').textContent = totalMatchups.toLocaleString();
                document.getElementById('leaguesCreated7d').textContent = leaguesCreated7d.toLocaleString();
                document.getElementById('newUsers7d').textContent = newUsers7d.toLocaleString();
                
                // Recent leagues
                const recentLeagues = leaguesData
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 10);
                
                const recentLeaguesTbody = document.querySelector('#recentLeagues tbody');
                recentLeaguesTbody.innerHTML = recentLeagues.map(league => {
                    const memberCount = membersData.filter(m => m.league_id === league.id).length;
                    const status = league.start_date ? 'Active' : 'Waiting';
                    return `
                        <tr>
                            <td>${league.name}</td>
                            <td>${new Date(league.created_at).toLocaleDateString()}</td>
                            <td>${memberCount}/${league.max_players}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                }).join('');
                
                // League size distribution
                const sizeCounts = {};
                leaguesData.forEach(league => {
                    const size = league.max_players;
                    sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                });
                
                const leagueSizesTbody = document.querySelector('#leagueSizes tbody');
                leagueSizesTbody.innerHTML = Object.entries(sizeCounts)
                    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
                    .map(([size, count]) => {
                        const percentage = ((count / totalLeagues) * 100).toFixed(1);
                        return `
                            <tr>
                                <td>${size} Players</td>
                                <td>${count}</td>
                                <td>${percentage}%</td>
                            </tr>
                        `;
                    }).join('');
                
                // User activity (last 7 days)
                const activityByDate = {};
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                    const dateStr = date.toISOString().split('T')[0];
                    activityByDate[dateStr] = {
                        newUsers: 0,
                        leaguesCreated: 0,
                        leaguesJoined: 0
                    };
                }
                
                usersData.forEach(user => {
                    const date = new Date(user.created_at).toISOString().split('T')[0];
                    if (activityByDate[date]) {
                        activityByDate[date].newUsers++;
                    }
                });
                
                leaguesData.forEach(league => {
                    const date = new Date(league.created_at).toISOString().split('T')[0];
                    if (activityByDate[date]) {
                        activityByDate[date].leaguesCreated++;
                    }
                });
                
                membersData.forEach(member => {
                    const date = new Date(member.joined_at).toISOString().split('T')[0];
                    if (activityByDate[date]) {
                        activityByDate[date].leaguesJoined++;
                    }
                });
                
                const userActivityTbody = document.querySelector('#userActivity tbody');
                userActivityTbody.innerHTML = Object.entries(activityByDate)
                    .map(([date, activity]) => {
                        const dateObj = new Date(date);
                        return `
                            <tr>
                                <td>${dateObj.toLocaleDateString()}</td>
                                <td>${activity.newUsers}</td>
                                <td>${activity.leaguesCreated}</td>
                                <td>${activity.leaguesJoined}</td>
                            </tr>
                        `;
                    }).join('');
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                showError('Error loading analytics: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        // Auto-connect if config exists
        if (savedUrl && savedKey) {
            setTimeout(() => connect(), 500);
        }
    </script>
</body>
</html>

